# Концепция за Автоматизация и Flow Архитектура

Този документ описва фундаменталните принципи, по които се изграждат автоматизациите (Flows) в Hydroponics v5. Целта е да се запази гъвкавост и лесна поддръжка.

## 1. Capabilities (Възможности)
Устройствата не се дефинират само от драйвера си, а от това какво **могат да правят** след калибрация.

*   **Как работи:** Всяка стратегия за калибрация отключва определени "възможности" (`capabilities`).
*   **Пример:** Стратегията `volumetric_flow` добавя възможност `dosing_ml`.
*   **Полза:** UI компонентите (Блоковете) питат "Можеш ли да дозираш?", а не "Имаш ли volumetric_flow стратегия?". Това позволява в бъдеще да добавим `gravimetric` (тегловна) стратегия, която също да дава `dosing_ml`, без да променяме UI.

## 2. Design Time vs Runtime (Проектиране срещу Изпълнение)

### FlowEditor (Design Time) - "Намерението"
Когато създаваме схема, ние дефинираме **какво искаме да постигнем**, а не как точно да стане технически.

*   **Роля:** Показва опции спрямо `capabilities` на устройството.
*   **Резултат (JSON):** Записва се **намерението**.
    *   *Правилно:* `action: "DOSE", amount: 50, unit: "ml"`
    *   *Грешно:* `action: "ON", duration: 5000`
*   **Защо:** Ако утре помпата се прекалибрира (дебитът падне), схемата остава вярна. 50ml са си 50ml, независимо колко време отнемат.

### FlowExecutor (Runtime) - "Изпълнението"
Това е "работникът", който превръща намерението в технически команди в момента на изпълнение.

*   **Роля:** Чете JSON файла стъпка по стъпка.
*   **Действие:** Когато види `DOSE 50ml`, той се обръща към **ConversionService**.
*   **Динамичност:** Винаги използва **текущата** активна калибрация на устройството в момента на изпълнение.

## 3. ConversionService (Мозъкът)
Централизирано място за математика и преобразуване.

*   **Вход:** "Помпа А", "50ml".
*   **Логика:**
    1.  Намира активната стратегия за `dosing_ml` (напр. `volumetric_flow`).
    2.  Взима `flowRate` от записаните данни на помпата.
    3.  Смята: `Време = Количество / Дебит`.
*   **Изход:** Команда към хардуера: `ON` за изчисленото време.
