{
    "id": "wifi_native",
    "type": "wifi",
    "name": "Native WiFi",
    "description": "Uses the on-board WiFi module (ESP8266, ESP32, Uno R4)",
    "compatible_architectures": [
        "esp8266",
        "esp32",
        "renesas_uno"
    ],
    "parameters": [
        {
            "name": "ssid",
            "type": "string",
            "default": "",
            "label": "WiFi SSID"
        },
        {
            "name": "password",
            "type": "password",
            "default": "",
            "label": "WiFi Password"
        },
        {
            "name": "udp_port",
            "type": "number",
            "default": 8888,
            "label": "UDP Port"
        },
        {
            "name": "baud_rate",
            "type": "number",
            "default": 115200,
            "label": "Serial Baud Rate"
        }
    ],
    "code": {
        "includes": {
            "esp8266": "#include <ESP8266WiFi.h>\n#include <WiFiUdp.h>",
            "esp32": "#include <WiFi.h>\n#include <WiFiUdp.h>",
            "renesas_uno": "#include <WiFiS3.h>\n#include <WiFiUdp.h>"
        },
        "globals": "WiFiUDP udp;\nchar packetBuffer[255];",
        "setup": [
            "Serial.begin({{baud_rate}});",
            "delay(2000); // Wait for Serial",
            "Serial.println(\"Booting...\");",
            "// Connect to WiFi",
            "Serial.print(\"Connecting to WiFi: {{ssid}}\");",
            "WiFi.begin(\"{{ssid}}\", \"{{password}}\");",
            "int wifiRetries = 0;",
            "while (WiFi.status() != WL_CONNECTED && wifiRetries < 20) {",
            "  delay(500);",
            "  Serial.print(\".\");",
            "  wifiRetries++;",
            "}",
            "Serial.println();",
            "if (WiFi.status() == WL_CONNECTED) {",
            "  Serial.println(\"WiFi Connected!\");",
            "  // Wait for IP Address",
            "  Serial.print(\"Waiting for IP\");",
            "  int ipRetries = 0;",
            "  while (WiFi.localIP() == IPAddress(0,0,0,0) && ipRetries < 20) {",
            "    delay(500);",
            "    Serial.print(\".\");",
            "    ipRetries++;",
            "  }",
            "  Serial.println();",
            "  Serial.print(\"IP Address: \");",
            "  Serial.println(WiFi.localIP());",
            "  udp.begin({{udp_port}});",
            "} else {",
            "  Serial.println(\"WiFi Connection Failed! Continuing...\");",
            "}"
        ],
        "loop": [
            "// UDP Handling",
            "int packetSize = udp.parsePacket();",
            "if (packetSize) {",
            "  Serial.print(\"Received UDP packet: \");",
            "  Serial.println(packetSize);",
            "  int len = udp.read(packetBuffer, 255);",
            "  if (len > 0) packetBuffer[len] = 0;",
            "  Serial.print(\"Payload: \");",
            "  Serial.println(packetBuffer);",
            "  String response = processCommand(String(packetBuffer));",
            "  udp.beginPacket(udp.remoteIP(), udp.remotePort());",
            "  udp.print(response);",
            "  udp.endPacket();",
            "}",
            "// Serial Handling (for debugging)",
            "if (Serial.available()) {",
            "  String input = Serial.readStringUntil('\\n');",
            "  input.trim();",
            "  if (input.length() > 0) {",
            "    Serial.print(\"Command received via Serial: \");",
            "    Serial.println(input);",
            "    String response = processCommand(input);",
            "    Serial.println(response);",
            "  }",
            "}"
        ]
    }
}