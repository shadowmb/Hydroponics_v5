{
    "id": "eeprom_state",
    "name": "EEPROM State Save",
    "description": "Restore relay states after power loss",
    "category": "reliability",
    "compatible_transports": [
        "*"
    ],
    "compatible_architectures": [
        "*"
    ],
    "parameters": [],
    "code": {
        "includes": "#include <EEPROM.h>",
        "globals": "#define ENABLE_EEPROM_STATE_SAVE\nvoid saveState(int pin, int state);\nvoid restoreState();",
        "setup": "#if defined(ESP8266) || defined(ESP32)\n  EEPROM.begin(512);\n#endif\nrestoreState();",
        "functions": {
            "esp8266": [
                "void saveState(int pin, int state) {",
                "  if (pin >= 512) return;",
                "  if (EEPROM.read(pin) != state) {",
                "    EEPROM.write(pin, state);",
                "    EEPROM.commit();",
                "  }",
                "}",
                "void restoreState() {",
                "  for (int i = 0; i < 20; i++) { // Scan first 20 pins",
                "    int val = EEPROM.read(i);",
                "    if (val == 0 || val == 1) {",
                "      pinMode(i, OUTPUT);",
                "      digitalWrite(i, val);",
                "    }",
                "  }",
                "}"
            ],
            "esp32": [
                "void saveState(int pin, int state) {",
                "  if (pin >= 512) return;",
                "  if (EEPROM.read(pin) != state) {",
                "    EEPROM.write(pin, state);",
                "    EEPROM.commit();",
                "  }",
                "}",
                "void restoreState() {",
                "  for (int i = 0; i < 40; i++) { // Scan first 40 pins",
                "    int val = EEPROM.read(i);",
                "    if (val == 0 || val == 1) {",
                "      pinMode(i, OUTPUT);",
                "      digitalWrite(i, val);",
                "    }",
                "  }",
                "}"
            ],
            "renesas_uno": [
                "void saveState(int pin, int state) {",
                "  if (EEPROM.read(pin) != state) {",
                "    EEPROM.write(pin, state);",
                "  }",
                "}",
                "void restoreState() {",
                "  for (int i = 0; i < 20; i++) {",
                "    int val = EEPROM.read(i);",
                "    if (val == 0 || val == 1) {",
                "      pinMode(i, OUTPUT);",
                "      digitalWrite(i, val);",
                "    }",
                "  }",
                "}"
            ],
            "*": [
                "void saveState(int pin, int state) {",
                "  if (EEPROM.read(pin) != state) {",
                "    EEPROM.write(pin, state);",
                "  }",
                "}",
                "void restoreState() {",
                "  for (int i = 0; i < 20; i++) {",
                "    int val = EEPROM.read(i);",
                "    if (val == 0 || val == 1) {",
                "      pinMode(i, OUTPUT);",
                "      digitalWrite(i, val);",
                "    }",
                "  }",
                "}"
            ]
        }
    }
}